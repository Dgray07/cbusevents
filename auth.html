<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Sign In — CBUSEVENTS</title>
<meta name="robots" content="noindex,nofollow"/>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@700;800&family=DM+Sans:wght@400;500;600&display=swap" rel="stylesheet">
<style>
*{box-sizing:border-box;margin:0;padding:0;}
:root{--bg:#0b0b0f;--surface:#13131a;--card:#1a1a24;--border:#25252f;--text:#e8e8f0;--sub:#8888a0;--muted:#55556a;--orange:#FF6B35;--green:#22c55e;--gold:#f59e0b;--blue:#60a5fa;--red:#ef4444;}
body{background:var(--bg);color:var(--text);font-family:'DM Sans',sans-serif;min-height:100vh;display:flex;flex-direction:column;}
@keyframes spin{to{transform:rotate(360deg);}}
@keyframes fadeUp{from{opacity:0;transform:translateY(20px);}to{opacity:1;transform:translateY(0);}}
@keyframes slideIn{from{opacity:0;transform:translateX(30px);}to{opacity:1;transform:translateX(0);}}

/* NAV */
nav{background:rgba(11,11,15,0.95);backdrop-filter:blur(16px);border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;padding:0 48px;height:62px;}
.nav-logo{font-family:'Syne',sans-serif;font-weight:800;font-size:20px;cursor:pointer;text-decoration:none;color:var(--text);}
.nav-logo span{color:var(--orange);}

/* LAYOUT */
.auth-wrap{flex:1;display:flex;align-items:center;justify-content:center;padding:40px 24px;}
.auth-container{width:100%;max-width:480px;animation:fadeUp 0.4s ease;}

/* CARD */
.auth-card{background:var(--card);border:1px solid var(--border);border-radius:20px;padding:40px;overflow:hidden;}
.auth-logo{font-family:'Syne',sans-serif;font-size:22px;font-weight:800;text-align:center;margin-bottom:4px;}
.auth-logo span{color:var(--orange);}
.auth-sub{color:var(--sub);font-size:13px;text-align:center;margin-bottom:28px;line-height:1.5;}

/* TABS */
.auth-tabs{display:grid;grid-template-columns:1fr 1fr;background:var(--surface);border-radius:10px;padding:4px;margin-bottom:24px;}
.auth-tab{background:none;border:none;color:var(--sub);padding:9px;border-radius:7px;font-size:14px;font-weight:500;cursor:pointer;transition:all 0.15s;font-family:'DM Sans',sans-serif;}
.auth-tab.active{background:var(--card);color:var(--text);font-weight:600;}

/* FORM */
.field{margin-bottom:14px;}
.field label{display:block;font-size:12px;color:var(--sub);font-weight:500;margin-bottom:5px;}
.field input{width:100%;background:var(--bg);border:1px solid var(--border);border-radius:8px;padding:10px 14px;color:var(--text);font-family:'DM Sans',sans-serif;font-size:14px;outline:none;transition:border-color 0.15s;}
.field input:focus{border-color:var(--orange);}
.auth-err{color:var(--red);font-size:13px;margin-bottom:10px;min-height:18px;}
.btn-primary{background:var(--orange);color:#fff;border:none;border-radius:8px;padding:12px;font-size:14px;font-weight:700;width:100%;cursor:pointer;font-family:'DM Sans',sans-serif;transition:opacity 0.15s;}
.btn-primary:hover{opacity:0.85;}
.btn-primary:disabled{opacity:0.5;cursor:not-allowed;}

/* ONBOARDING STEPS */
.step{display:none;animation:slideIn 0.3s ease;}
.step.active{display:block;}
.step-indicator{display:flex;gap:6px;justify-content:center;margin-bottom:24px;}
.step-dot{width:8px;height:8px;border-radius:50%;background:var(--border);transition:all 0.3s;}
.step-dot.active{background:var(--orange);width:24px;border-radius:4px;}
.step-dot.done{background:var(--green);}
.step-title{font-family:'Syne',sans-serif;font-size:18px;font-weight:800;margin-bottom:6px;text-align:center;}
.step-sub{color:var(--sub);font-size:13px;text-align:center;margin-bottom:24px;}

/* ROLE CARDS */
.role-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:20px;}
.role-card{background:var(--surface);border:1.5px solid var(--border);border-radius:12px;padding:18px 14px;cursor:pointer;transition:all 0.2s;text-align:center;}
.role-card:hover{border-color:var(--orange);}
.role-card.selected{border-color:var(--orange);background:#FF6B3510;}
.role-icon{font-size:30px;margin-bottom:8px;}
.role-name{font-weight:700;font-size:14px;margin-bottom:3px;}
.role-desc{font-size:11px;color:var(--sub);line-height:1.4;}

/* CLAIM STEP */
.claim-card{background:var(--surface);border:1.5px solid var(--border);border-radius:12px;padding:16px 18px;cursor:pointer;transition:all 0.2s;margin-bottom:10px;display:flex;align-items:center;gap:14px;}
.claim-card:hover{border-color:var(--orange);}
.claim-card.selected{border-color:var(--orange);background:#FF6B3510;}
.claim-card-icon{font-size:28px;flex-shrink:0;}
.claim-card-name{font-weight:700;font-size:14px;margin-bottom:2px;}
.claim-card-meta{font-size:12px;color:var(--sub);}
.claim-check{margin-left:auto;width:20px;height:20px;border-radius:50%;border:2px solid var(--border);flex-shrink:0;display:flex;align-items:center;justify-content:center;font-size:11px;transition:all 0.15s;}
.claim-card.selected .claim-check{background:var(--orange);border-color:var(--orange);color:#fff;}

/* BACK LINK */
.back-btn{background:none;border:none;color:var(--sub);font-size:13px;cursor:pointer;display:flex;align-items:center;gap:4px;margin-bottom:16px;font-family:'DM Sans',sans-serif;padding:0;}
.back-btn:hover{color:var(--text);}

/* LOADER */
.auth-loader{text-align:center;padding:20px 0;}
.spinner{width:32px;height:32px;border:3px solid var(--border);border-top-color:var(--orange);border-radius:50%;animation:spin 0.8s linear infinite;margin:0 auto 12px;}
</style>
</head>
<body> <nav> <a href="https://cbusevents.com" class="nav-logo">CBUS<span>EVENTS</span></a> <a href="https://cbusevents.com" style="color:var(--sub);font-size:13px;text-decoration:none;">← Back to site</a>
</nav> <div class="auth-wrap"> <div class="auth-container"> <div class="auth-card"> <!-- SIGN IN MODE --> <div id="signinView"> <div class="auth-logo">CBUS<span>EVENTS</span></div> <p class="auth-sub">Welcome back to Columbus</p> <div class="auth-tabs"> <button class="auth-tab active" onclick="setMode('signin')">Sign In</button> <button class="auth-tab" onclick="setMode('signup')">Create Account</button> </div> <div class="field"><label>Email</label><input type="email" id="siEmail" placeholder="you@email.com" onkeydown="if(event.key==='Enter')doSignIn()"/></div> <div class="field"><label>Password</label><input type="password" id="siPass" placeholder="••••••••" onkeydown="if(event.key==='Enter')doSignIn()"/></div> <div class="auth-err" id="siErr"></div> <button class="btn-primary" id="siBtn" onclick="doSignIn()">Sign In →</button> <div style="text-align:center;margin-top:14px"> <button onclick="setMode('reset')" style="background:none;border:none;color:var(--muted);font-size:12px;cursor:pointer">Forgot password?</button> </div> </div> <!-- RESET MODE --> <div id="resetView" style="display:none"> <div class="auth-logo">CBUS<span>EVENTS</span></div> <p class="auth-sub">Enter your email to reset your password</p> <div class="field"><label>Email</label><input type="email" id="rstEmail" placeholder="you@email.com"/></div> <div class="auth-err" id="rstErr"></div> <button class="btn-primary" onclick="doReset()">Send Reset Email →</button> <div style="text-align:center;margin-top:14px"> <button onclick="setMode('signin')" style="background:none;border:none;color:var(--orange);font-size:13px;cursor:pointer">← Back to sign in</button> </div> </div> <!-- SIGNUP ONBOARDING --> <div id="signupView" style="display:none"> <!-- Step indicators --> <div class="step-indicator"> <div class="step-dot active" id="dot1"></div> <div class="step-dot" id="dot2"></div> <div class="step-dot" id="dot3"></div> <div class="step-dot" id="dot4"></div> </div> <!-- STEP 1: Role selection --> <div class="step active" id="step1"> <div class="step-title">What brings you to CBUSEVENTS?</div> <div class="step-sub">We'll set up the right account for you</div> <div class="role-grid"> <div class="role-card" id="role-venue_owner" onclick="selectRole('venue_owner')"> <div class="role-name">Venue Owner</div> <div class="role-desc">I own or manage an event space or bar</div> </div> <div class="role-card" id="role-vendor" onclick="selectRole('vendor')"> <div class="role-name">Vendor</div> <div class="role-desc">I offer services like DJ, catering, photography</div> </div> <div class="role-card" id="role-planner" onclick="selectRole('planner')"> <div class="role-name">Event Planner</div> <div class="role-desc">I plan and organize events for clients</div> </div> <div class="role-card" id="role-customer" onclick="selectRole('customer')"> <div class="role-name">Attendee</div> <div class="role-desc">I want to discover events in Columbus</div> </div> </div> <div class="auth-err" id="step1Err"></div> <button class="btn-primary" onclick="nextStep(2)">Continue →</button> </div> <!-- STEP 2: Details based on role --> <div class="step" id="step2"> <button class="back-btn" onclick="goBack(1)">← Back</button> <div class="step-title" id="step2Title">Tell us about yourself</div> <div class="step-sub" id="step2Sub">Just a few quick details</div> <div id="step2Fields"></div> <div class="auth-err" id="step2Err"></div> <button class="btn-primary" onclick="nextStep(3)">Continue →</button> </div> <!-- STEP 2b: Claim existing listing --> <div class="step" id="stepClaim"> <button class="back-btn" onclick="goBack(2)">← Back</button> <div class="step-title">We found a match!</div> <div class="step-sub" id="claimSub">Is this your venue? Claim it to take ownership.</div> <div id="claimResults"></div> <div class="auth-err" id="claimErr"></div> <button class="btn-primary" id="claimBtn" onclick="proceedWithClaim()">Claim This Listing →</button> <button onclick="goBack(2)" style="background:none;border:none;color:var(--sub);font-size:13px;cursor:pointer;width:100%;margin-top:10px;padding:8px;">Not my venue — create a new listing</button> </div> <!-- STEP 3: Account creation --> <div class="step" id="step3"> <button class="back-btn" onclick="goBack(2)">← Back</button> <div class="step-title">Create your account</div> <div class="step-sub" id="step3Sub">Almost there!</div> <div class="field"><label>Email</label><input type="email" id="suEmail" placeholder="you@email.com" onkeydown="if(event.key==='Enter')doSignUp()"/></div> <div class="field"><label>Password</label><input type="password" id="suPass" placeholder="At least 6 characters" onkeydown="if(event.key==='Enter')doSignUp()"/></div> <div class="auth-err" id="suErr"></div> <button class="btn-primary" id="suBtn" onclick="doSignUp()">Create Account →</button> </div> <!-- LOADING --> <div class="step" id="stepLoading"> <div class="auth-loader"> <div class="spinner"></div> <div style="color:var(--sub);font-size:14px" id="loadingMsg">Setting up your account…</div> </div> </div> </div> </div> <div style="text-align:center;margin-top:16px;color:var(--muted);font-size:12px"> By creating an account you agree to our terms of service
 </div> </div>
</div> <script src="https://unpkg.com/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
<script>
const SB_URL="https://toblgvatvsjljbqogzsv.supabase.co";
const SB_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRvYmxndmF0dnNqbGpicW9nenN2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIxMDgwNTAsImV4cCI6MjA4NzY4NDA1MH0._WJEQPizNDiQfDXQB_DHPaQhixPGpMdmYQSmyWmm_FQ";
const sb=supabase.createClient(SB_URL,SB_KEY);

const PORTAL_URLS={
 venue_owner:'https://cbusevents.com/cbus-venue-portal.html',
 vendor:'https://cbusevents.com/cbus-vendor-portal.html',
 planner:'https://cbusevents.com/cbus-planner-portal.html',
 customer:'https://cbusevents.com/customer-portal.html',
};

let selectedRole=null;
let stepData={};
let currentStep=1;

// ── CHECK IF ALREADY LOGGED IN ────────────────────────────────
async function init(){
 const{data:{session}}=await sb.auth.getSession();
 if(session?.user) await redirectByRole(session.user.id);

 // Pre-select role if passed in URL
 const params=new URLSearchParams(window.location.search);
 const roleParam=params.get('role');
 if(roleParam&&['venue_owner','vendor','planner','customer'].includes(roleParam)){
 setMode('signup');
 selectRole(roleParam);
 nextStep(2);
 }
}

// ── MODE SWITCHING ────────────────────────────────────────────
function setMode(mode){
 document.getElementById('signinView').style.display=mode==='signin'?'block':'none';
 document.getElementById('resetView').style.display=mode==='reset'?'block':'none';
 document.getElementById('signupView').style.display=mode==='signup'?'block':'none';
 if(mode==='signup'){currentStep=1;showStep(1);}
}

// ── SIGN IN ───────────────────────────────────────────────────
async function doSignIn(){
 const email=document.getElementById('siEmail').value.trim();
 const pass=document.getElementById('siPass').value;
 const err=document.getElementById('siErr');
 const btn=document.getElementById('siBtn');
 if(!email||!pass){err.textContent='Email and password required.';return;}
 btn.disabled=true;btn.textContent='Signing in…';err.textContent='';
 const{data,error}=await sb.auth.signInWithPassword({email,password:pass});
 if(error){err.textContent=error.message;btn.disabled=false;btn.textContent='Sign In →';return;}
 await redirectByRole(data.user.id);
}

async function redirectByRole(userId){
 const{data}=await sb.from('user_roles').select('role').eq('user_id',userId).maybeSingle();
 const role=data?.role||'customer';
 window.location.href=PORTAL_URLS[role]||PORTAL_URLS.customer;
}

// ── RESET ─────────────────────────────────────────────────────
async function doReset(){
 const email=document.getElementById('rstEmail').value.trim();
 const err=document.getElementById('rstErr');
 if(!email){err.textContent='Enter your email.';return;}
 const{error}=await sb.auth.resetPasswordForEmail(email,{redirectTo:'https://cbusevents.com/auth.html'});
 if(error){err.textContent=error.message;return;}
 err.style.color='var(--green)';err.textContent=' Reset email sent! Check your inbox.';
}

// ── ROLE SELECTION ────────────────────────────────────────────
function selectRole(role){
 selectedRole=role;
 document.querySelectorAll('.role-card').forEach(c=>c.classList.remove('selected'));
 document.getElementById('role-'+role)?.classList.add('selected');
 document.getElementById('step1Err').textContent='';
}

// ── STEP NAVIGATION ───────────────────────────────────────────
function showStep(n){
 currentStep=n;
 document.querySelectorAll('.step').forEach(s=>s.classList.remove('active'));
 document.getElementById('step'+n)?.classList.add('active');
 // Update dots — claim counts as step 2.5 visually
 const dotN = n==='Claim'?2 : n==='Loading'?4 : n;
 [1,2,3,4].forEach(i=>{
 const dot=document.getElementById('dot'+i);
 if(!dot)return;
 dot.classList.remove('active','done');
 if(i<dotN)dot.classList.add('done');
 else if(i===dotN)dot.classList.add('active');
 });
}

function nextStep(n){
 if(n===2){
 if(!selectedRole){document.getElementById('step1Err').textContent='Please select an account type.';return;}
 buildStep2();
 showStep(2);
 } else if(n===3){
 if(!validateStep2())return;
 if(selectedRole==='venue_owner'){
 checkForExistingVenue();
 } else {
 buildStep3Summary();
 showStep(3);
 }
 }
}

function goBack(n){showStep(n);}

function buildStep2(){
 const configs={
 venue_owner:{title:'Tell us about your venue',sub:'You can add more details in your portal',fields:[
 {id:'venueName',label:'Venue Name *',placeholder:'e.g. The Basement Bar'},
 {id:'venueType',label:'Type of Venue',placeholder:'e.g. Bar, Event Space, Comedy Club'},
 {id:'venueNeighborhood',label:'Neighborhood',placeholder:'e.g. Short North, Downtown'},
 ]},
 vendor:{title:'Tell us about your business',sub:'You can fill out your full profile in the vendor portal',fields:[
 {id:'bizName',label:'Business Name *',placeholder:'e.g. Columbus Creative Co.'},
 {id:'bizCategory',label:'What do you offer?',placeholder:'e.g. DJ, Photography, Catering'},
 ]},
 planner:{title:'Tell us about yourself',sub:'You can complete your profile in the planner portal',fields:[
 {id:'plannerName',label:'Your Name *',placeholder:'e.g. Jordan Smith'},
 {id:'plannerCompany',label:'Company (optional)',placeholder:'e.g. Columbus Events Co.'},
 ]},
 customer:{title:'What are you into?',sub:'We\'ll personalize your Columbus event feed',fields:[
 {id:'displayName',label:'Your Name',placeholder:'e.g. Alex'},
 ]},
 };
 const c=configs[selectedRole];
 document.getElementById('step2Title').textContent=c.title;
 document.getElementById('step2Sub').textContent=c.sub;
 document.getElementById('step2Fields').innerHTML=c.fields.map(f=>`
 <div class="field"><label>${f.label}</label><input id="${f.id}" placeholder="${f.placeholder}" onkeydown="if(event.key==='Enter')nextStep(3)"/></div> `).join('');
}

function validateStep2(){
 const required={venue_owner:'venueName',vendor:'bizName',planner:'plannerName',customer:null};
 const reqId=required[selectedRole];
 if(reqId){
 const val=document.getElementById(reqId)?.value?.trim();
 if(!val){document.getElementById('step2Err').textContent='Please fill in the required field.';return false;}
 }
 // Store step 2 data
 const allInputs=document.getElementById('step2Fields').querySelectorAll('input');
 allInputs.forEach(inp=>{stepData[inp.id]=inp.value.trim();});
 return true;
}

function buildStep3Summary(){
 const labels={venue_owner:'Venue Owner',vendor:'Vendor',planner:'Event Planner',customer:'Attendee'};
 document.getElementById('step3Sub').textContent=`Creating your ${labels[selectedRole]} account`;
}

// ── CLAIM FLOW ────────────────────────────────────────────────
async function checkForExistingVenue(){
 const name = stepData.venueName || '';
 if(!name){buildStep3Summary();showStep(3);return;}

 // Search for unclaimed venues with similar name
 const{data:matches}=await sb.from('venues')
 .select('id,name,venue_type,neighborhood,status,cover_image_url')
 .is('owner_id',null)
 .ilike('name','%'+name.split(' ')[0]+'%')
 .limit(5)
 .catch(()=>({data:[]}));

 // Also check claimed venues with same name (to warn of duplicates)
 const{data:claimed}=await sb.from('venues')
 .select('id,name,owner_id')
 .ilike('name','%'+name+'%')
 .not('owner_id','is',null)
 .limit(3)
 .catch(()=>({data:[]}));

 const unclaimedMatches=(matches||[]).filter(m=>!m.owner_id);

 if(!unclaimedMatches.length){
 // No match — just create new
 buildStep3Summary();
 showStep(3);
 return;
 }

 // Show claim step
 claimMatches=unclaimedMatches;
 selectedClaimId=null;
 document.getElementById('claimSub').textContent=`We found ${unclaimedMatches.length} existing listing${unclaimedMatches.length>1?'s':''} that match "${name}". Is one of these yours?`;
 document.getElementById('claimResults').innerHTML=unclaimedMatches.map(v=>`
 <div class="claim-card" id="claim-${v.id}" onclick="selectClaim('${v.id}')"> <div class="claim-card-icon">${v.cover_image_url?`<img src="${v.cover_image_url}" style="width:44px;height:44px;border-radius:8px;object-fit:cover" onerror="this.outerHTML=''"/>`:''}</div> <div style="flex:1"> <div class="claim-card-name">${v.name}</div> <div class="claim-card-meta">${v.venue_type||'Venue'}${v.neighborhood?' · '+v.neighborhood:''} · <span style="color:${v.status==='approved'?'#22c55e':'#f59e0b'}">${v.status==='approved'?'Live':'Pending'}</span></div> </div> <div class="claim-check" id="check-${v.id}"></div> </div>`).join('')+`
 <div class="claim-card" id="claim-new" onclick="selectClaim('new')" style="border-style:dashed"> <div style="flex:1"> <div class="claim-card-name">Create a new listing for "${name}"</div> <div class="claim-card-meta">My venue isn't listed above</div> </div> <div class="claim-check" id="check-new"></div> </div>`;
 document.getElementById('claimErr').textContent='';
 showStep('Claim');
}

function selectClaim(id){
 selectedClaimId=id;
 document.querySelectorAll('.claim-card').forEach(c=>c.classList.remove('selected'));
 document.querySelectorAll('.claim-check').forEach(c=>c.textContent='');
 document.getElementById('claim-'+id)?.classList.add('selected');
 const chk=document.getElementById('check-'+id);
 if(chk)chk.textContent='';
 document.getElementById('claimErr').textContent='';
}

function proceedWithClaim(){
 if(!selectedClaimId){document.getElementById('claimErr').textContent='Please select an option.';return;}
 buildStep3Summary();
 if(selectedClaimId==='new'){
 document.getElementById('step3Sub').textContent='Creating your Venue Owner account — new listing';
 } else {
 const v=claimMatches.find(m=>m.id===selectedClaimId);
 document.getElementById('step3Sub').textContent=`Creating your account and claiming "${v?.name||'venue'}"`;
 }
 showStep(3);
}

// ── SIGN UP ───────────────────────────────────────────────────
async function doSignUp(){
  const email=document.getElementById('suEmail').value.trim();
  const pass=document.getElementById('suPass').value;
  const errEl=document.getElementById('suErr');
  const btn=document.getElementById('suBtn');
  if(!email||!pass){errEl.textContent='Email and password required.';return;}
  if(pass.length<6){errEl.textContent='Password must be at least 6 characters.';return;}
  btn.disabled=true;btn.textContent='Creating account…';errEl.textContent='';

  showStep('Loading');
  document.getElementById('loadingMsg').textContent='Creating your account…';

  // 1. Create auth user
  const{data,error:authErr}=await sb.auth.signUp({email,password:pass});
  console.log('SIGNUP RESPONSE:', JSON.stringify({
    user: data?.user?.id,
    email: data?.user?.email,
    confirmed: data?.user?.email_confirmed_at,
    session: !!data?.session,
    error: authErr?.message,
    status: authErr?.status,
  }));
  if(authErr){
    showStep(3);
    const msg=authErr.message||'';
    const lmsg=msg.toLowerCase();
    if(lmsg.includes('already registered')||lmsg.includes('already exists')||lmsg.includes('duplicate')){
      document.getElementById('suErr').innerHTML='An account with this email already exists. <button onclick="setMode(\'signin\')" style="background:none;border:none;color:var(--orange);font-size:13px;cursor:pointer;text-decoration:underline;padding:0">Sign in instead →</button>';
    } else if(lmsg.includes('database')||lmsg.includes('error saving')){
      // Supabase returns this when email confirmation is on — account WAS created
      document.getElementById('suErr').style.color='#4ade80';
      document.getElementById('suErr').innerHTML='Account created! <button onclick="setMode(\'signin\')" style="background:none;border:none;color:var(--orange);font-size:13px;cursor:pointer;text-decoration:underline;padding:0">Sign in to continue →</button>';
      btn.textContent='Sign In →';
      btn.onclick=()=>setMode('signin');
      btn.disabled=false;
    } else {
      // Show the EXACT error so we can diagnose
      document.getElementById('suErr').textContent=msg||'Signup failed — please try again.';
      console.error('SIGNUP AUTH ERROR:', authErr);
      btn.disabled=false;btn.textContent='Create Account →';
    }
    return;
  }
  const userId=data.user?.id;
  if(!userId){
    showStep(3);
    document.getElementById('suErr').textContent='Signup failed — please try again.';
    btn.disabled=false;btn.textContent='Create Account →';
    return;
  }
  // 2. If no session (edge case), try signing in immediately with same credentials
  let finalUserId = userId;
  let finalSession = data.session;
  if(!finalSession){
    const{data:siData, error:siErr} = await sb.auth.signInWithPassword({email, password:pass});
    if(!siErr && siData?.session){
      finalSession = siData.session;
      finalUserId = siData.user?.id || userId;
    } else {
      // Still no session - account may need a moment, just redirect to sign in
      showStep(3);
      document.getElementById('suErr').style.color='#4ade80';
      document.getElementById('suErr').innerHTML='Account created! <button onclick="setMode(\'signin\')" style="background:none;border:none;color:var(--orange);font-size:13px;cursor:pointer;text-decoration:underline;padding:0">Sign in to continue →</button>';
      btn.textContent='Sign In →';
      btn.onclick=()=>setMode('signin');
      btn.disabled=false;
      return;
    }
  }

  // Short wait for session to be available
  await new Promise(r=>setTimeout(r,600));
  document.getElementById('loadingMsg').textContent='Setting up your profile…';

  // 3. Set role
  const roleMap={planner:'customer'};
  const dbRole=roleMap[selectedRole]||selectedRole;
  try { await sb.from('user_roles').upsert({user_id:finalUserId,role:dbRole},{onConflict:'user_id'}); }
  catch(e){ console.warn('role:',e?.message); }

  // 4. Create profile — fire and forget, NEVER block redirect on DB errors
  const destUrl = PORTAL_URLS[selectedRole]||PORTAL_URLS.customer;

  (async()=>{
    try {
      if(selectedRole==='venue_owner'){
        if(selectedClaimId&&selectedClaimId!=='new'){
          await sb.from('venues').update({
            owner_id:finalUserId, claim_status:'pending',
            claimed_at:new Date().toISOString(), claim_email:email,
          }).eq('id',selectedClaimId);
          try { await sb.from('user_roles').update({claim_venue_id:selectedClaimId}).eq('user_id',finalUserId); } catch(e){}
        } else {
          await sb.from('venues').insert({
            name:stepData.venueName||'My Venue',
            venue_type:stepData.venueType||null,
            neighborhood:stepData.venueNeighborhood||null,
            owner_id:finalUserId, status:'pending', tier:'free', city:'Columbus', state:'OH',
          });
        }
      } else if(selectedRole==='vendor'){
        await sb.from('vendors').upsert({
          user_id:finalUserId,
          business_name:stepData.bizName||'My Business',
          category:stepData.bizCategory||null,
          email:email,
          subscription_tier:'FREE',
          subscription_status:'active',
        },{onConflict:'user_id'});
      } else {
        // planner and attendee both use customer_profiles
        await sb.from('customer_profiles').upsert({
          user_id:finalUserId,
          display_name:stepData.plannerName||stepData.displayName||null,
        },{onConflict:'user_id'});
      }
    } catch(profileErr){
      // Profile insert failed — not critical, user can complete profile in portal
      console.warn('Profile setup error (non-blocking):', profileErr?.message);
    }
  })();

  // Redirect immediately — don't wait for profile insert
  document.getElementById('loadingMsg').textContent='Redirecting to your portal…';
  setTimeout(()=>{ window.location.href=destUrl; }, 600);
}

init();
</script>
</body>
</html>
